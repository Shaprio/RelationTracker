{# templates/meetings.html.twig #}
{% extends 'base.html.twig' %}

{% block title %}
    Meetings
{% endblock %}

{% block content %}
    <div class="header">
        <h1>Meetings</h1>
        <button id="addEventBtn">Add New Event</button>
    </div>

    <div class="meeting-list">
        {% for event in events %}
            <div class="meeting-item">
                <p>Title: {{ event.title }}</p>
                <p>Description: {{ event.description }}</p>
                <p>Date: {{ event.date|date('Y-m-d') }}</p>
                <p>Contacts:
                    {% for contact in event.contact %}
                        {{ contact.contact.name }}{% if not loop.last %}, {% endif %}
                    {% endfor %}
                </p>
                <button class="editEventBtn" data-id="{{ event.id }}">Edit</button>
                <button
                    class="important-btn {{ event.isImportant ? 'marked' : '' }}"
                    data-id="{{ event.id }}"
                    data-type="meeting"
                >
                    {{ event.isImportant ? 'Unmark Important' : 'Mark as Important' }}
                </button>
            </div>
        {% else %}
            <p>No meetings available.</p>
        {% endfor %}
    </div>

    <!-- Modal -->
    <div class="modal" id="eventModal">
        <div class="modal-content">
            <!-- Zamykamy modal przyciskiem? Zdefiniuj go, jeśli chcesz -->
            <!-- <button id="closeModal">Close</button> -->

            <form method="POST" action="/meetings">
                <input type="hidden" name="event_id" id="eventId">
                <input type="text" name="title" id="eventTitle" placeholder="Title" required>
                <textarea name="description" id="eventDescription" placeholder="Description"></textarea>
                <input type="date" name="date" id="eventDate" required>
                <label>Contacts:</label>
                <select name="contacts[]" id="eventContacts" multiple>
                    {% for contact in contacts %}
                        <option value="{{ contact.id }}">{{ contact.name }}</option>
                    {% endfor %}
                </select>
                <button type="submit">Save</button>
            </form>
        </div>
    </div>
{% endblock %}

{% block javascripts %}
    <script>
        // JavaScript logic for modal
        const modal = document.getElementById('eventModal');
        const addEventBtn = document.getElementById('addEventBtn');
        const editEventBtns = document.querySelectorAll('.editEventBtn');
        const importantBtns = document.querySelectorAll('.important-btn');

        // Open Add Event Modal
        if (addEventBtn) {
            addEventBtn.addEventListener('click', () => {
                if (modal) {
                    modal.style.display = 'flex';
                    document.getElementById('eventId').value = '';
                    document.getElementById('eventTitle').value = '';
                    document.getElementById('eventDescription').value = '';
                    document.getElementById('eventDate').value = '';

                    // Odczytaj #eventContacts i wyczyść zaznaczenia
                    const eventContacts = document.getElementById('eventContacts');
                    Array.from(eventContacts.options).forEach(option => {
                        option.selected = false;
                    });
                }
            });
        }

        // (Optional) If you have a "closeModal" button inside the form
        const closeModal = document.getElementById('closeModal');
        if (closeModal) {
            closeModal.addEventListener('click', () => {
                if (modal) {
                    modal.style.display = 'none';
                }
            });
        }

        // Edit Event Modal
        editEventBtns.forEach(btn => {
            btn.addEventListener('click', () => {
                if (modal) {
                    modal.style.display = 'flex';
                    const parent = btn.closest('.meeting-item');

                    // Populate the modal fields
                    document.getElementById('eventId').value =
                        btn.getAttribute('data-id') || '';
                    document.getElementById('eventTitle').value =
                        parent.querySelector('p:nth-of-type(1)').textContent.split(': ')[1] || '';
                    document.getElementById('eventDescription').value =
                        parent.querySelector('p:nth-of-type(2)').textContent.split(': ')[1] || '';
                    document.getElementById('eventDate').value =
                        parent.querySelector('p:nth-of-type(3)').textContent.split(': ')[1] || '';

                    // #eventContacts - bez detali, bo np. nie mamy przypisanych kontaktów w HTML p
                }
            });
        });

        // Toggle Important Logic
        importantBtns.forEach(btn => {
            btn.addEventListener('click', () => {
                const eventId = btn.getAttribute('data-id');
                const eventType = btn.getAttribute('data-type'); // "meeting" or "recurring"
                const isImportant = btn.classList.contains('marked');

                // Determine the correct API endpoint based on type
                const url = (eventType === 'meeting')
                    ? `/meetings/${eventId}/important`
                    : `/recurring-events/${eventId}/important`;

                // Send POST request to toggle importance
                fetch(url, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ important: !isImportant })
                })
                    .then(response => {
                        if (!response.ok)
                            throw new Error('Failed to update importance');
                        return response.json();
                    })
                    .then(data => {
                        if (data.success) {
                            btn.classList.toggle('marked');
                            btn.textContent = isImportant
                                ? 'Mark as Important'
                                : 'Unmark Important';
                        }
                    })
                    .catch(error => console.error('Error:', error));
            });
        });

        // Close Modal on Outside Click
        window.addEventListener('click', (e) => {
            if (e.target === modal) {
                modal.style.display = 'none';
            }
        });
    </script>
{% endblock %}
